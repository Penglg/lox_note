<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lox笔记-分区</title>
</head>
<body>
<div style="text-align: center">
    <h1>lox笔记</h1><br><br>

    <a href="http://localhost:8080/pages/user/note.html">返回首页</a>

    <button id="show-section-btn" type="button">展示分区</button>
    <div style="text-align: center">
        <table id="show-section"></table>
    </div>

    <br><br>
    <label for="page">选择页数</label>
    <input type="text" id="page">

    <br><br>
    <div style="text-align: center">
        <table id="show-notes"></table>
    </div>

</div>

<script src="../../js/jquery-3.6.0.js" type="text/javascript"></script>
<script>
    $(function () {

        $("#show-section-btn").click(function () {

            $.ajax({
                type: "get",
                url: "http://localhost:8080/sections",
                async: false,
                success: function (result) {
                    if (result.code === 30001) {
                        let table;

                        table = "<tr>" +
                            "<th>分区名</th>" + "<th>分区描述</th>" + "<th>查看该分区笔记</th>" +
                            "</tr>";

                        for (let i = 0; i < result.data.length; ++i) {
                            let buttonId = "choose-btn" + i;

                            let line = "<tr>" +
                                "<td>" + result.data[i].name + "</td>" +
                                "<td>" + result.data[i].desc + "</td>" +
                                "<td><button id=" + buttonId + ">查看</button>" + "</td>" +
                                "</tr>";
                            table = table + line;
                        }

                        $("#show-section").html(table);

                        // 给每个按钮绑定操作
                        for (let i = 0; i < result.data.length; ++i) {
                            let buttonId = "choose-btn" + i;

                            $("#" + buttonId).click(function () {
                                let pageNum = $("#page").val();
                                let pageNumPatt = /^\d{1,5}$/;

                                if (!pageNumPatt.test(pageNum)) {
                                    alert("没有正确输入页数！");
                                    return false;
                                }


                                $.ajax({
                                    type: "get",
                                    url: "/notes/section/" + result.data[i].id + "?isLegal = 1&pageNum=" + pageNum,
                                    async: false,
                                    success: function (result) {
                                        let table;

                                        table = "<tr>" +
                                            "<th>标题</th>" + "<th>点赞数</th>" + "<th>收藏数</th>" + "<th>发布时间</th>" +
                                            "<th>查看</th>" + "<th>点赞</th>" + "<th>收藏</th>" +
                                            "</tr>";

                                        for (let i = 0; i < result.data.items.length; ++i) {
                                            let buttonId1 = "detail-btn" + i;
                                            let likeBtnId = "like-btn" + i;
                                            let collectBtnId = "collect-btn" + i;

                                            let line = "<tr>" +
                                                "<td>" + result.data.items[i].title + "</td>" +
                                                "<td>" + result.data.items[i].likes + "</td>" +
                                                "<td>" + result.data.items[i].collect + "</td>" +
                                                "<td>" + result.data.items[i].dateTime + "</td>" +
                                                "<td><button id=" + buttonId1 + " >查看</button>" + "</td>" +
                                                "<td><button id=" + likeBtnId + " >点赞</button>" + "</td>" +
                                                "<td><button id=" + collectBtnId + " >收藏</button>" + "</td>" +
                                                "</tr>";
                                            table = table + line;
                                        }

                                        $("#show-notes").html(table);

                                        // 给每个按钮绑定操作
                                        for (let i = 0; i < result.data.items.length; ++i) {
                                            let buttonId1 = "detail-btn" + i;
                                            let likeBtnId = "like-btn" + i;
                                            let collectBtnId = "collect-btn" + i;

                                            // 查看功能，即笔记详细页
                                            $("#" + buttonId1).click(function () {
                                                location.href = 'http://localhost:8080/pages/user/note_detail.html?id=' + result.data.items[i].id;
                                            })

                                            // 点赞功能
                                            $("#" + likeBtnId).click(function () {
                                                $.ajax({
                                                    type:"post",
                                                    url:"/likes",
                                                    async:true,
                                                    headers:{"Content-Type":"application/json;charset=UTF-8"},
                                                    data:JSON.stringify({
                                                        noteId:result.data.items[i].id
                                                    }),
                                                    dataType:"json",
                                                    success: function (result) {
                                                        if (result.code === 30001) alert("点赞成功！");
                                                        else alert("点赞失败！");
                                                    },
                                                    error: function () {
                                                        alert("系统繁忙，稍后再试");
                                                    }
                                                })
                                            })

                                            // 收藏功能
                                            $("#" + collectBtnId).click(function () {
                                                $.ajax({
                                                    type:"post",
                                                    url:"/collects",
                                                    async:true,
                                                    headers:{"Content-Type":"application/json;charset=UTF-8"},
                                                    data:JSON.stringify({
                                                        noteId:result.data.items[i].id
                                                    }),
                                                    dataType:"json",
                                                    success: function (result) {
                                                        if (result.code === 30001) alert("收藏成功！");
                                                        else alert("收藏失败！");
                                                    },
                                                    error: function () {
                                                        alert("系统繁忙，稍后再试");
                                                    }
                                                })
                                            })
                                        }
                                    }
                                })
                            })
                        }
                    }
                    else {
                        alert("操作失败！");
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试");
                }

            })

        })



    })


</script>
</body>
</html>