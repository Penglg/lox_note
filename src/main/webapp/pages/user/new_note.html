<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lox笔记-创建笔记</title>
</head>
<body>
<div style="text-align: center">
    <h1>新 建 笔 记</h1><br><br>
    <a href="http://localhost:8080/pages/user/note.html">返回主页</a><br><br>

    <form>
        <label for="n-title">标题</label>
        <input id="n-title" type="text" placeholder="请输入标题"><br><br>
        <label for="n-content">内容</label>
        <input id="n-content" type="text" placeholder="请输入内容"><br><br>
        <input id="n-sectionId" type="hidden">
        <label for="n-approvalContent">申请审批内容说明（可为空）</label>
        <input id="n-approvalContent" type="text"><br><br>
        <button id="submit-btn">提交</button><br><br>
    </form>

    <button id="showSections-btn">展示并选择分区</button>
    <div style="text-align: center">
        <table id="section"></table>
    </div>

    <button id="showTags-btn">展示并选择标签</button>
    <div style="text-align: center">
        <table id="tag"></table>
    </div>

</div>

<script src="../../js/jquery-3.6.0.js" type="text/javascript"></script>
<script>
    $(function () {
        let title;
        let content;
        let sectionId = "";
        let approvalContent;

        $("#showSections-btn").click(function () {
            $.ajax({
                type: "get",
                url: "http://localhost:8080/sections",
                async: false,
                success: function (result) {
                    let table;

                    table = "<tr>" +
                        "<th>分区名</th>" + "<th>分区描述</th>" + "<th>选择（点哪个选哪个，只会选最后点的那个）</th>" +
                        "</tr>";

                    for (let i = 0; i < result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        let line = "<tr>" +
                            "<td>" + result.data[i].name + "</td>" +
                            "<td>" + result.data[i].desc + "</td>" +
                            "<td><button id=" + buttonId + ">选择</button>" + "</td>" +
                            "</tr>";
                        table = table + line;
                    }

                    $("#section").html(table);

                    // 给每个按钮绑定操作
                    for (let i = 0; i < result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        $("#" + buttonId).click(function () {
                            sectionId = result.data[i].id;
                            $("#n-sectionId").val(result.data[i].id);
                        })
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试");
                }
            })
        })


        let tagId1 = null;
        let tagId2 = null;
        let tagId3 = null;

        $("#showTags-btn").click(function () {
            $.ajax({
                type:"get",
                url:"/tags",
                async:false,
                success: function (result) {
                    let table = "<tr>" +
                        "<th>标签名</th>" + "<th>标签描述</th>" + "<th>选择（点击哪个选哪个，只有点的前三个有效）</th>" +
                        "</tr>";

                    for (let i = 0; i <result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        let line = "<tr>" +
                            "<td>" + result.data[i].name + "</td>" +
                            "<td>" + result.data[i].desc + "</td>" +
                            "<td><button id=" + buttonId + ">选择</button>" + "</td>" +
                            "</tr>";
                        table = table + line;
                    }

                    $("#tag").html(table);

                    // 绑定
                    for (let i = 0; i < result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        $("#" + buttonId).click(function () {
                            if (tagId1 === null || tagId1 === "") {
                                tagId1 = result.data[i].id;
                                return true;
                            }
                            if (tagId2 === null || tagId2 === "") {
                                if (tagId1 !== result.data[i].id) {
                                    tagId2 = result.data[i].id;
                                    return true;
                                }
                                else {
                                    alert("不能选择重复的标签！");
                                    return false;
                                }
                            }
                            if (tagId3 === null || tagId3 === "") {
                                if (tagId1 !== result.data[i].id && tagId2 !== result.data[i].id) {
                                    tagId3 = result.data[i].id;
                                    return true;
                                } else {
                                    alert("不能选择重复的标签！");
                                    return false;
                                }
                            }
                            alert("最多只能选择三个标签！");
                        })
                    }

                },
                error: function () {
                    alert("系统繁忙，稍后再试");
                }
            })


        })

        $("#submit-btn").click(function () {
            title = $("#n-title").val();
            content = $("#n-content").val();
            approvalContent = $("#n-approvalContent").val();

            // 标题
            let titlePatt = /^\w{6,12}$/;
            if (!titlePatt.test(title)) {
                alert("标题不合法！");
                return false;
            }

            // 内容
            if (content == null || content === "") {
                alert("内容不能为空！");
                return false;
            }

            // 分区
            if (sectionId == null || sectionId === "") {
                alert("不可不选择分区！");
                return false;
            }

            if (tagId1 === null) tagId1 = -1;
            if (tagId2 === null) tagId2 = -1;
            if (tagId3 === null) tagId3 = -1;

            $.ajax({
                type: "post",
                url: "/notes",
                headers: {"Content-Type": "application/json;charset=UTF-8"},
                async: false,
                data: JSON.stringify({
                    title: title,
                    content: content,
                    sectionId: $("#n-sectionId").val(),
                    approvalContent: approvalContent,
                    tags: [
                        {
                            id:tagId1
                        },
                        {
                            id: tagId2
                        },
                        {
                            id: tagId3
                        }
                    ]
                }),
                dataType: "json",
                success: function (result) {
                    if (result.code === 30001) {
                        alert("新建成功！");
                        history.go(-1);
                    } else {
                        alert("新建失败！");
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试")
                }
            })
        })
    })



</script>
</body>
</html>