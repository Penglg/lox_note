<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lox笔记-创建笔记</title>
</head>
<body>
<div style="text-align: center">
    <h1>新 建 笔 记</h1><br><br>

    <form>
        <label for="n-title">标题</label>
        <input id="n-title" type="text" placeholder="请输入标题"><br><br>
        <label for="n-content">内容</label>
        <input id="n-content" type="text" placeholder="请输入内容"><br><br>
        <input id="n-sectionId" type="hidden">
        <label for="n-approvalContent">申请审批内容说明（可为空）</label>
        <input id="n-approvalContent" type="text"><br><br>
        <button id="submit-btn">提交</button><br><br>
    </form>



    <button id="showSections-btn">展示并选择分区</button>
    <div style="text-align: center">
        <table id="section"></table>
    </div>
</div>

<script src="../../js/jquery-3.6.0.js" type="text/javascript"></script>
<script>
    $(function () {
        let title;
        let content;
        let sectionId = "";
        let approvalContent;

        $("#showSections-btn").click(function () {
            $.ajax({
                type: "get",
                url: "http://localhost:8080/sections",
                async: false,
                success: function (result) {
                    let table;

                    table = "<tr>" +
                        "<th>分区名</th>" + "<th>分区描述</th>" + "<th>选择（点哪个选哪个，只会选最后点的那个）</th>" +
                        "</tr>";

                    for (let i = 0; i < result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        let line = "<tr>" +
                            "<td>" + result.data[i].name + "</td>" +
                            "<td>" + result.data[i].desc + "</td>" +
                            "<td><button id=" + buttonId + ">选择</button>" + "</td>" +
                            "</tr>";
                        table = table + line;
                    }

                    $("#section").html(table);

                    // 给每个按钮绑定操作
                    for (let i = 0; i < result.data.length; ++i) {
                        let buttonId = "choose-btn" + i;

                        $("#" + buttonId).click(function () {
                            sectionId = result.data[i].id;
                            $("#n-sectionId").val(result.data[i].id);
                        })
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试");
                }
            })
        })

        $("#submit-btn").click(function () {
            title = $("#n-title").val();
            content = $("#n-content").val();
            approvalContent = $("#n-content").val();

            // 标题
            let titlePatt = /^\w{6,12}$/;
            if (!titlePatt.test(title)) {
                alert("标题不合法！");
                return false;
            }

            // 内容
            if (content == null || content === "") {
                alert("内容不能为空！");
                return false;
            }

            // 分区
            if (sectionId == null || sectionId === "") {
                alert("不可不选择分区！");
                return false;
            }



            $.ajax({
                type: "post",
                url: "/notes",
                headers: {"Content-Type": "application/json;charset=UTF-8"},
                async: false,
                data: JSON.stringify({
                    title: title,
                    content: content,
                    sectionId: $("#n-sectionId").val(),
                    approvalContent: approvalContent
                }),
                dataType: "json",
                success: function (result) {
                    if (result.code == 30001) {
                        alert("新建成功！");
                        history.go(-1);
                    } else {
                        alert("新建失败！");
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试")
                }
            })
        })
    })



</script>
</body>
</html>