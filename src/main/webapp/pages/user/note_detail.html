<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>lox笔记-详细页</title>
</head>
<body>
<div style="text-align: center">
    <h1>笔记详细</h1><br><br>
    <a href="http://localhost:8080/pages/user/note.html">返回主页</a>
    <button id="back" type="button">返回上一页</button><br><br>

    <button id="show-btn" type="button">展示</button>
    <div style="text-align: center">
        <table id="show"></table>
    </div>

    <br><br>
    <label for="comment">评论内容</label>
    <input type="text" id="comment"><br><br>
    <button id="new-comment" type="button">发表评论</button>
    <br><br>

    <button id="show-comment-btn" type="button">展示评论</button>
    <div style="text-align: center">
        <table id="show-comment"></table>
    </div>
</div>

<script src="../../js/jquery-3.6.0.js" type="text/javascript"></script>
<script>
    $(function () {
        let url = decodeURI(location.href);
        let args = url.split("?id="); // 获取url携带参数
        let id = args[1];

        $("#show-btn").click(function () {
            $.ajax({
                type:"get",
                url:"/notes/" + id,
                async:false,
                success: function (result) {
                    if (result.code === 30001) {
                        let table;

                        table = "<tr>" +
                            "<th>标题</th>" + "<th>内容</th>" + "<th>点赞数</th>" + "<th>收藏数</th>" + "<th>发布日期</th>" +
                            "</tr>" +
                            "<tr>" +
                            "<td>" + result.data.title + "</td>" +
                            "<td>" + result.data.content + "</td>" +
                            "<td>" + result.data.likes + "</td>" +
                            "<td>" + result.data.collect + "</td>" +
                            "<td>" + result.data.dateTime + "</td>" +
                            "</tr>";

                        $("#show").html(table);
                    } else {
                        alert("获取失败！请重新载入");
                    }
                },
                error:function () {
                    alert("系统繁忙，稍后再试");
                }
            })
        })

        $("#show-comment-btn").click(function () {
            $.ajax({
                type:"get",
                url:"http://localhost:8080/comments/note/" + id,
                async:false,
                success:function (result) {
                    if (result.code === 30001) {
                        let table;

                        table = "<tr>" +
                            "<th>评论人</th>" + "<th>内容</th>" + "<th>发布日期</th>" +
                            "</tr>";

                        for (let i = 0; i < result.data.length; ++i) {
                            let line = "<tr>" +
                            "<td>" + result.data[i].user.name + "</td>" +
                            "<td>" + result.data[i].content + "</td>" +
                            "<td>" + result.data[i].dateTime + "</td>" +
                            "</tr>";

                            table = table + line;
                        }

                        $("#show-comment").html(table);
                    } else {
                        alert("获取失败！请重新载入");
                    }
                },
                error:function () {
                    alert("系统繁忙，稍后再试");
                }
            })
        })

        $("#new-comment").click(function () {
            let content = $("#comment").val();
            if (content == null || content === "") {
                alert("评论内容不能为空！");
                return false;
            }

            $.ajax({
                type: "post",
                url: "/comments",
                async: false,
                headers: {"Content-Type": "application/json;charset=UTF-8"},
                data: JSON.stringify({
                    noteId:id,
                    content:content
                }),
                dataType:"json",
                success: function (result) {
                    if (result.code === 30001) {
                        alert("发表成功！");
                    }
                    else {
                        alert("发表失败");
                    }
                },
                error: function () {
                    alert("系统繁忙，稍后再试！");
                }

            })
        })

        $("#back").click(function () {
            history.go(-1);
        })
    })
</script>
</body>
</html>